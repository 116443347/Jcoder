
<style>
    .modal-dialog {
        width: 650px;
    }
</style>

<script>

function select_all_sections(){
	if($("#select_all").prop("checked") == true){
		var departmentOption = '';
		$(".chosen-select-5 option").each(function() {  
        	departmentOption += '<option value="'+ $(this).attr("value") +'" selected>'+ $(this).prop("text") +'</option>';
        });  
	}else{
		var departmentOption = '';
		$(".chosen-select-5 option").each(function() {  
        	departmentOption += '<option value="'+ $(this).attr("value") +'">'+ $(this).prop("text") +'</option>';
        });
	}
	Vue.nextTick(function () {
		$(".chosen-select-5").trigger("chosen:updated").chosen();
	})
	$(".chosen-select-5").html(departmentOption);
	$('.chosen-select-5').chosen({allow_single_deselect:true});
	roleAddOrEdit.selectSections = $('.chosen-select-5').val();
}

var roleAddOrEdit = new Vue({
    el: '#roleAddOrEdit',
    data: {
    	item:{},
    	role: {},
        sites:[],
        sections:[],
        selectSections:'',
        selectSites:null,
        sectionsSize:null
    },
    watch:{
    	'role':function(){
    		this.item = this.role;
    		this.selectSections = this.role.sectionIds;
    		$("#roleName").val(this.item.name);
    		$("#description").val(this.item.description);
    		this.initSections();
    	},
    },
    updated: function(){
		autosize($('textarea[class*=autosize]'));
    },
    mounted: function () { // 初始化执行
        var $this = this;
        $this.selectSections = '';
    	$this.initSections();
    },
    methods: { // 方法
    	//初始化所有的字段下拉框
		initSections:function(){
			var $this = this;
			var ids = '';
			JqdeMods.ajax('pmpSectionAction', 'getSections').then(function (result) {
				$this.sections = result.rows;
				$this.sectionsSize = result.rows.length;
				var arr = null;
				if($this.selectSections != null)arr = $this.selectSections;
             	// 元数据库列表
                var sectionOption = '';
                for (var i = 0; i < $this.sections.length; i++){
                    if(arr != null && arr.indexOf($this.sections[i].id) > -1) {
                    	sectionOption += '<option value="'+ $this.sections[i].id +'" selected>'+ $this.sections[i].section_name +'</option>';
                    } else{
                    	sectionOption += '<option value="'+ $this.sections[i].id +'">'+ $this.sections[i].section_name +'</option>';
                    }
                }
                $(".chosen-select-5").html(sectionOption);
                $('.chosen-select-5').chosen({allow_single_deselect:true});
				
				Vue.nextTick(function(){
					$(".chosen-select-5").trigger("chosen:updated").chosen();
					$(".chosen-select-5").change(function(){
						var sectionlist = $('.chosen-select-5').val();
						if(sectionlist instanceof Array){
							$this.selectSections = $('.chosen-select-5').val();
						}else{
							var sectionArray = [];
							sectionArray.push($('.chosen-select-5').val());
							$this.selectSections = sectionArray;
						}
						if(sectionlist != null && sectionlist != undefined && $this.sectionsSize == sectionlist.length){
							$("#select_all").prop("checked",true);
						}else{
							$("#select_all").attr("checked",false);
						}
	       			});
				}); 
			});
		},
    	// 验证表单
        valid: function () {
        	$("#roleName").val($.trim($("#roleName").val()));
   			if($('#roleName').val() != ''){
   				$("#role-error-message").text('');
   				var flag = false;
   				$(".chosen-select-5 option").each(function(){
					if(this.selected)flag = true;
				});
   				if(flag){
   					$("#section-error-message").text('');
   					return true;
   				}else{
   					$("#section-error-message").text('栏目不能为空');
   					return false;
   				}
   				return true;
   			}else{
   				$("#role-error-message").text('角色名称不能为空');
   				return false;
   			}
        },
        // 更新ajaxPramas
        updateAjaxPramas: function () {
			if(this.valid()){
				this.item.description = $("#description").val();
				var sectionIds = '';
				if(this.selectSections  instanceof Array){
					for(var i = 0;i<this.selectSections.length;i++){
						if(i == (this.selectSections.length - 1)){
							sectionIds+=this.selectSections[i];
							continue;
						}
						sectionIds +=this.selectSections[i]+',';
					}	
				}
				
				var sectionNames = '';
				$(".chosen-select-5 option").each(function(){
					if(this.selected)sectionNames +=$(this).text()+',';
				});
				this.item.name = $("#roleName").val();
				this.item.sectionNames = sectionNames.substring(0,(sectionNames.length-1));				
				this.item.sectionIds = sectionIds != ''?sectionIds:this.selectSections;
				this.role = this.item;
			}	        	
        }
    }
});
</script>
