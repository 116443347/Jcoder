<div id="groupHostList">
    <div class="row">
        <div class="col-xs-6">
            <button class="btn btn-xs btn-info" @click="add()">
                <i class="ace-icon glyphicon glyphicon-plus bigger-100"></i> 添加
            </button>
            <button class="btn btn-xs btn-danger" @click="delAll()" :disabled="items.length==0">
                <i class="ace-icon glyphicon glyphicon-remove bigger-100"></i>删除
            </button>
            <button class="btn btn-xs btn-success" type="button" @click="hostList()">
                <i class="ace-icon glyphicon glyphicon-refresh bigger-100"></i>刷新
            </button>
        </div>
    </div>

    <div class="space-4"></div>

    <div class="row">
        <div class="col-xs-12">
            <div class="table-responsive dataTables_wrapper">
                <table id="dynamic-table" class="table table-striped table-bordered table-hover">
                    <thead>
                    <tr>
						<th class="center" style="border-bottom: 0px solid #ddd;">
							<label class="pos-rel">
								<input type="checkbox" class="ace"/>
								<span class="lbl"></span>
							</label>
						</th>
						<th class="center">组名称</th>
						<th class="center">主机名称</th>
						<th class="center">SSL支持</th>
						<th class="center">集群同步</th>
						<th class="center">权重</th>
						<th class="center">操作</th>
                    </tr>
                    </thead>
                    <tbody class="infor-tbody">
                    	<tr v-for="(item, index) in items">
							<td class="center">
								<label class="pos-rel">
									<input type="checkbox" class="ace checkadmin" :value="item.hostPort" :name="item.hostPort"/>
									<span class="lbl"></span>
								</label>
							</td>
							<td  class="center">{{groupName}}</td>
							<td  class="center">{{item.hostPort}}</td>
							<td  class="center">
								<span v-show="item.ssl" class="label label-sm label-success">HTTPS</span>
								<span v-show="!item.ssl" class="label label-sm label-success">HTTP</span>
							</td>
							<td  class="center">
								<span v-show="item.current" class="label label-sm label-success">同步中</span>
								<span v-show="!item.current" class="label label-sm label-danger">未同步</span>
							</td>
							<td  class="left">
								<input type="text" v-model="item.weight" class="col-sm-12" style="height:18px;" @change="changeWeight(item.hostPort,item.weight)">
							</td>
							<td  class="center">
								<div class="hidden-sm hidden-xs btn-group" style="text-align:center;">
		                            <div class="editbutton" style="display:inline;">
	                                    <a class="red" href="javascript:;" style="margin-left:7px;" title="删除" @click="del(item.hostPort,groupName)">
		                                    <i class="ace-icon fa fa-trash bigger-130"></i>
		                                </a>
                                    </div>
		                        </div>

								<div class="hidden-sm hidden-xs btn-group" style="text-align:center;">
									<div class="editbutton" style="display:inline;">
										<a class="red" href="javascript:;" style="margin-left:7px;" title="下载" @click="downSDK(item.hostPort,groupName)">
											<i class="ace-icon fa fa-cloud-download bigger-130"></i>
										</a>
									</div>
								</div>

								<div class="hidden-sm hidden-xs btn-group" style="text-align:center;">
									<div class="editbutton" style="display:inline;">
										<a class="red" href="javascript:;" style="margin-left:7px;" title="克隆" @click="share(item.hostPort)">
											<i class="ace-icon fa fa-share bigger-130"></i>
										</a>
									</div>
								</div>

								<div class="hidden-sm hidden-xs btn-group" style="text-align:center;">
									<div class="editbutton" style="display:inline;">
										<a class="red" href="javascript:;" style="margin-left:7px;" title="刷新" @click="flush(item.hostPort)">
											<i class="ace-icon fa fa-refresh bigger-130"></i>
										</a>
									</div>
								</div>

							</td>
						</tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>


	<h5 class="header smaller lighter blue"  v-show="diffs.length>0">
		<i class="ace-icon fa fa-hand-o-right green"></i>冲突处理
	</h5>

	<div class="row" v-show="diffs.length>0">

		<div class="col-xs-12">
			<div class="table-responsive dataTables_wrapper">
				<table id="diff-table" class="table table-striped table-bordered table-hover">
					<thead>
					<tr>
						<th class="center" style="border-bottom: 0px solid #ddd;">
							<label class="pos-rel">
								<input type="checkbox" class="ace"/>
								<span class="lbl"></span>
							</label>
						</th>
						<th class="center">组名称</th>
						<th class="center">主机名称</th>
						<th class="center">路径</th>
						<th class="center">类型</th>
						<th class="center">信息</th>
						<th class="center">操作</th>
					</tr>
					</thead>
					<tbody class="infor-tbody">
					<tr v-for="(item, index) in diffs">
						<td class="center">
							<label class="pos-rel">
								<input type="checkbox" class="ace checkadmin" :value="item.hostPort" :name="item.hostPort"/>
								<span class="lbl"></span>
							</label>
						</td>
						<td  class="center">{{groupName}}</td>
						<td  class="center">{{diffHostPort}}</td>
						<td  class="left">
							{{item.path}}
						</td>
						<td  class="center">
							{{item.type==1?"文件":"Task"}}
						</td>
						<td  class="center">
							{{item.message}}
						</td>
						<td  class="center">
							<button type="button" class="btn btn-info btn-sm" @click="fixDiff(diffHostPort ,null, item.path)">
								<i class="ace-icon fa fa-upload bigger-110"></i>当前替换主版本
							</button>

							<button type="button" class="btn btn-info btn-sm" @click="fixDiff(null ,diffHostPort, item.path)">
								<i class="ace-icon fa fa-download bigger-110"></i>主版本替换当前
							</button>

						</td>
					</tr>
					</tbody>
				</table>

				<div  class="row center">
					<button type="button" class="btn btn-info btn-sm">
						<i class="ace-icon fa fa-upload bigger-110"></i>当前替换主版本
					</button>

					<button type="button" class="btn btn-info btn-sm">
						<i class="ace-icon fa fa-download bigger-110"></i>主版本替换当前
					</button>
				</div>
			</div>
		</div>
	</div>
</div>



<script type="text/javascript" >
var groupHostList = new Vue({
  el: '#groupHostList',
  data: {
    items: [],
    groupName: "",
    hostPorts:[],
    diffs:[],
    diffHostPort:"",
    currentHostPort:""
  },
  mounted:function(){
  	this.groupName = param.name ;
  	this.hostList();
  	// check all
	var $table = $('#dynamic-table');
	$table.on('click', 'th input[type=checkbox]', function () {
		var th_checked = this.checked;
		$table.find('td input[type=checkbox]').each(function () {
			this.checked = th_checked;
		});
	});

	$table = $('#diff-table');
	$table.on('click', 'th input[type=checkbox]', function () {
		var th_checked = this.checked;
		$table.find('td input[type=checkbox]').each(function () {
			this.checked = th_checked;
		});
	});
  },
  methods:{
	hostList:function(){
		var $this = this;
		Jcoder.ajax('/admin/group/groupHostList', 'post',{"name":$this.groupName},null).then(function (data) {
			JqdeBox.unloading();
			if(data.ok){
			  $this.items = data.obj;
			  return false ;
		  }
		});
	},

	changeWeight:function(hostPort,weight){
		var $this = this;
		JqdeBox.loading();
		Jcoder.ajax('/admin/group/changeWeight', 'post',{"name":$this.groupName,"weight":weight,"hostPort":hostPort},null).then(function (data) {
			JqdeBox.unloading();
			JqdeBox.message(data.ok, data.message);
		});
	},

	del: function(hostPort,groupName){
		var $this = this;
		JqdeBox.confirm("确定删除组在："+hostPort,function(status){
			if(status){
				JqdeBox.loading();
				Jcoder.ajax("/admin/group/delete", 'post',{"hostPorts":hostPort,"name":groupName},null).then(function (data) {
					JqdeBox.unloading();
					if(data.ok){
						$this.hostList();
						JqdeBox.message(true, data.message);
					}else{
						JqdeBox.message(false, data.message);
					}
				});
			}
		}) ;
	},

	hostArray: function () {
		var $this = this;
		var len = $(":checkbox").length ;
		for(var i =1 ;i<len ;i++){
		 if($(":checkbox")[i].checked==true){
			$this.hostPorts.push($this.items[i-1].hostPort);
		 }
		}
	},

	delAll: function(){
		var $this = this;
		$this.hostArray();
		JqdeBox.confirm("确定删除组："+$this.hostPorts.toString(),function(status){
			if(status){
				JqdeBox.loading();
				Jcoder.ajax("/admin/group/delete", 'post',{"hostPorts":$this.hostPorts.toString(),"name":$this.groupName},null).then(function (data) {
					JqdeBox.unloading();
					if(data.ok){
						$this.hostList();
						JqdeBox.message(true, data.message);
					}else{
						JqdeBox.message(false, data.message);
					}
				});
			}
		}) ;
	},

	downSDK: function(hostPort,groupName){
		var $this = this;
		location.href = "/admin/group/downSDK?groupName="+encodeURI(groupName)+"&hostPort="+encodeURI(hostPort) ;
	},

	share: function(hostPort){
		var $this = this;
		JqdeBox.dialog({
              title: "克隆",
              url: 'modules/group/groupShare.html',
              confirm: function () {
              	  JqdeBox.loading();
            	  var param = groupShare.item;
            	  groupShare.hostArray();
            	  Jcoder.ajax("/admin/group/share", 'post',{"hostPorts":groupShare.toHosts.toString(),"groupName":$this.groupName,"formHostPort":hostPort},null).then(function (data) {
                      JqdeBox.unloading();
                      if(data.ok){
                    	  $this.hostList();
  	  					  JqdeBox.message(true, data.message);
  	  				  }else{
  	  					JqdeBox.message(false, data.message);
  	  				  }
                  });
              }
          });
	},

	flush: function(hostPort){
		var $this = this;
		Jcoder.ajax("/admin/group/flush", 'post',{"hostPort":hostPort,"groupName":$this.groupName},null).then(function (data) {
			JqdeBox.unloading();
			if(data.ok){
				console.log(data.obj)
				$this.diffs = data.obj ;
				$this.hostList();
				if($this.diffs.length==0){
					JqdeBox.message(data.ok, hostPort+" 已与主版本一致");
				}
				$this.diffHostPort = hostPort ;
				$this.items.forEach(function(v){
					if(v.current){
						$this.currentHostPort = v;
					}
				}) ;
			}else{
				JqdeBox.message(false, data.message);
			}
		});
	},


	fixDiff: function(fromHostPort ,toHostPort, relativePath){
		var $this = this;
		Jcoder.ajax("/admin/group/fixDiff", 'post',{"fromHostPort":fromHostPort,"groupName":$this.groupName,"relativePath":relativePath},null).then(function (data) {
			JqdeBox.message(data.ok, data.message);
			if(fromHostPort){
				$this.flush(fromHostPort);
			}
			if(toHostPort){
				$this.flush(toHostPort);
			}
			JqdeBox.unloading();
		});
	}

  }



});
</script>